<!DOCTYPE html>
<html>

<head>
  <title>fermymf.html</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      color: black;
    }
    .background {
      min-height: 100vh;
      background: url("Img/Screenshot_2025-03-24_114434 (1).jpg") no-repeat center center;
      background-size: cover;
      background-attachment: fixed;
      padding: 20px;
      box-sizing: border-box;
      position: relative;
    }
    .name { position: absolute; top: 50px; left: 180px; color: black; }
    .imp { height: 90px; width: 90px; position: absolute; left: 250px; top: 110px; }
    h4, h3 { margin: 0; padding: 0; color: black; }
    .feed { margin-top: 100px; margin-left: 20px; }
    .fishonly {
      margin-top: 50px; padding: 20px;
      background-color: rgba(255,255,255,0.7);
      border-radius: 10px; color: black;
      position: relative;
    }
    label { display: inline-block; width: 150px; color: black; }
    .line { height: 2px; background: black; margin: 10px 0; }
    
    /* Expense Area Styles */
    .expenseArea {
      position: absolute;
      top: 280px;
      margin: 20px;
      padding: 20px;
      background-color: rgba(255,255,255,0.95);
      border-radius: 12px;
      color: black;
      display: none;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      width: 85%;
      max-width: 650px;
      z-index: 100;
    }
    
    .expense-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .expense-title {
      font-size: 1.4rem;
      font-weight: bold;
      color: #333;
    }
    
    .expense-close-btn {
      background: none;
      border: none;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      color: #666;
      padding: 5px;
    }
    
    .expense-list {
      max-height: 400px;
      overflow-y: auto;
      padding-right: 5px;
    }
    
    .expense-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      margin-bottom: 10px;
      background-color: #f8f9fa;
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    
    .expense-item:hover {
      background-color: #e9ecef;
      transform: translateY(-2px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .expense-info {
      flex: 1;
    }
    
    .expense-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 3px;
    }
    
    .expense-frequency {
      font-size: 0.85rem;
      color: #6c757d;
    }
    
    .expense-amount {
      font-weight: bold;
      color: #dc3545;
      min-width: 80px;
      text-align: right;
    }
    
    .no-expenses {
      text-align: center;
      padding: 30px;
      color: #6c757d;
      font-style: italic;
    }
    
    .expense-summary {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #e0e0e0;
      font-weight: bold;
    }
    
    .expense-total {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    
    .total-label {
      color: #495057;
    }
    
    .total-amount {
      color: #212529;
    }
    
    /* Scrollbar styling */
    .expense-list::-webkit-scrollbar {
      width: 6px;
    }
    
    .expense-list::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }
    
    .expense-list::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 3px;
    }
    
    .expense-list::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    
    button.expenses {
      background: #4CAF50; 
      color: white;
      border: none; 
      padding: 10px 20px;
      border-radius: 5px; 
      cursor: pointer;
      margin: 20px;
    }
    
    /* New gofish button styles */
    button.gofish {
      background: #ff4444;  /* Red color */
      color: white;
      border: none; 
      padding: 10px 20px;
      border-radius: 5px; 
      cursor: pointer;
      margin: 20px;
      margin-top: 0; /* Remove top margin to sit right below expenses button */
    }
    
    span { color: black; }
    .back { height: 50px; width: 50px; }
    .editbtn {
      background: red; 
      position: absolute;
      right: 20px;
      top: 80px;
    }
    .display {
      background: red; 
      padding: 15px;
      position: absolute;
      right: 20px;
      top: 20px;
      width: 220px;
      text-align: center; 
      display: none;
      border-radius: 8px;
      color: white;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .display input { 
      margin: 8px 0;
      width: 90%;
      padding: 5px;
    }
    .display button.close-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: none;
      border: none;
      color: white;
      font-weight: bold;
      cursor: pointer;
      font-size: 16px;
    }
    .editbtntwo {
      background: red;
      position: absolute;
      right: 20px;
      top: 260px;
    }
    .displaya {
      width: 220px; 
      background: red; 
      padding: 15px;
      position: absolute;
      right: 20px;
      top: 290px;
      color: white; 
      border-radius: 8px;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: none;
    }
    .displaya input {
      width: 100%; 
      margin-bottom: 10px;
      padding: 5px;
    }
    .displaya button.close-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: none;
      border: none;
      color: white;
      font-weight: bold;
      cursor: pointer;
      font-size: 16px;
    }
    .edit-salary-btn {
      background: blue; 
      color: white;
      border: none; 
      padding: 10px 20px;
      border-radius: 5px; 
      cursor: pointer;
      margin: 20px;
    }
    .section-title {
      display: inline-block;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <div class="background">
    <a href="mfish.html"><img src="Img/1746667598930.png" class="back"></a>
    <div class="name">
      <h4 id="class">Class: Loading...</h4>
      <h4 id="name">User: Loading...</h4>
    </div>
    <img class="imp" src="Img/Imp design 2.1-01 (1)-7.png">
    <div class="feed">
      <label>Salary:</label><span id="salary">Loading...</span><br>
      <label>Stipend:</label><span id="stipend">Loading...</span><br>
      <label>Allowance:</label><span id="allowance">Loading...</span><br>
      <label>Project Cap:</label><span id="project">Loading...</span>
      <button class="edit-salary-btn" id="editSalaryBtn">Edit Salary Group</button>
    </div>
    <button class="expenses" onclick="toggleExpenses()">Show Expenses</button>
    <button class="gofish" onclick="window.location.href='gofish.html'">gofish</button> <!-- New gofish button -->
    <div class="expenseArea" id="expenseArea"></div>
    <div class="fishonly" id="fishonly">
      <h3 class="section-title">FISH only</h3>
      <div class="display" id="extrasDisplay"></div>
      <div class="line"></div>
      <h2>Extra Expenses</h2>
      <button class="editbtn" onclick="edit()">edit</button>
      <label>Travel allowance:</label><span id="travel">Loading...</span><br>
      <label>Food allowance:</label><span id="food">Loading...</span><br>
      <label>Extra allowance:</label><span id="extra">Loading...</span><br>
      <h2 class="section-title">Totals</h2><br>
      <div class="displaya" id="totalsDisplay"></div>
      <button onclick="editbtntwo()" class="editbtntwo">edit</button>
      <label>Bill total:</label><span id="bills">Loading...</span><br>
      <label>w/extra:</label><span id="addextra">Loading...</span><br>
      <label>w/bonus:</label><span id="addbonus">Loading...</span>
      <h2>Goal</h2>
      <label>Daily:</label><span id="daily">Loading...</span><br>
      <label>Weekly:</label><span id="weekly">Loading...</span>
    </div>
  </div>

<script>
  let display = null;

  // Helper functions
  function safeParse(data) {
    try { return data ? JSON.parse(data) : null; } 
    catch (e) { return null; }
  }

  function findUser(array, count) {
    return Array.isArray(array) ? array.find(item => item.count === count) : null;
  }

  function validateNumber(value, fallback = 0) {
    const num = parseFloat(value);
    return isNaN(num) ? fallback : num;
  }

  function showLoadingState(show) {
    document.querySelectorAll('[id="salary"], [id="allowance"], [id="stipend"], [id="project"]')
      .forEach(el => {
        el.textContent = show ? 'Loading...' : '$0';
      });
  }

  function initStorageDefaults() {
    // Initialize salaryData with proper structure if it doesn't exist
    if (!localStorage.getItem('salaryData')) {
        localStorage.setItem('salaryData', JSON.stringify({
            salary: 0,
            allowance: 0,
            stipend: 0,
            project: 0
        }));
    } else {
        // Ensure existing data has all required fields
        const existingData = JSON.parse(localStorage.getItem('salaryData'));
        const defaultData = {
            salary: 0,
            allowance: 0,
            stipend: 0,
            project: 0
        };
        localStorage.setItem('salaryData', JSON.stringify({
            ...defaultData,
            ...existingData
        }));
    }
    
    if (!localStorage.getItem('extrasData')) {
        localStorage.setItem('extrasData', JSON.stringify({
            travelValue: '0',
            foodValue: '0',
            extraValue: '0'
        }));
    }
}

  function handleErrors() {
    const fallbacks = {
      salary: 0,
      allowance: 0,
      stipend: 0,
      project: 0,
      travel: 0,
      food: 0,
      extra: 0,
      bills: 0,
      addextra: 0,
      addbonus: 0,
      daily: 0,
      weekly: 0
    };
    
    Object.entries(fallbacks).forEach(([id, value]) => {
      const el = document.getElementById(id);
      if (el && el.textContent === 'Loading...') {
        el.textContent = `$${value}`;
      }
    });
  }

  function populateExtrasData(data) {
    const defaults = { travelValue: '0', foodValue: '0', extraValue: '0' };
    const merged = data ? {...defaults, ...data} : defaults;
    
    document.getElementById('travel').textContent = `$${merged.travelValue}`;
    document.getElementById('food').textContent = `$${merged.foodValue}`;
    document.getElementById('extra').textContent = `$${merged.extraValue}`;
  }

  function calculateTotalExpenses() {
    try {
        // Clear any cached calculations
        localStorage.removeItem('monthlyExpenses');
        
        // Get fresh data
        const expenses = safeParse(localStorage.getItem('expenses')) || [];
        const extrasData = safeParse(localStorage.getItem('extrasData')) || {};
        
        // Filter expenses for current user
        const userExpenses = expenses.filter(exp => exp.count === 0);
        
        // Calculate base total
        const baseTotal = userExpenses.reduce((sum, exp) => sum + validateNumber(exp.billamt), 0);
        
        // Calculate extras
        const travel = validateNumber(extrasData.travelValue);
        const food = validateNumber(extrasData.foodValue);
        const extra = validateNumber(extrasData.extraValue);
        const totalWithExtras = baseTotal + travel + food + extra;
        
        // Calculate bonus (original + half)
        const bonusValue = totalWithExtras + (totalWithExtras / 2);
        
        // Calculate goals
        const daily = (bonusValue / 42).toFixed(2);
        const weekly = (bonusValue / 6).toFixed(2);
        
        // Update UI immediately
        updateFinancialUI({
            bills: baseTotal,
            addextra: totalWithExtras,
            addbonus: bonusValue,
            daily,
            weekly
        });
        
        // Save for persistence
        localStorage.setItem('monthlyExpenses', JSON.stringify({
            bills: baseTotal,
            addextra: totalWithExtras,
            addbonus: bonusValue,
            daily,
            weekly,
            count: 0
        }));
        
        return baseTotal;
    } catch (error) {
        console.error("Error in calculateTotalExpenses:", error);
        return 0;
    }
  }

  function updateFinancialUI(data) {
    document.getElementById('bills').textContent = `$${data.bills.toFixed(2)}`;
    document.getElementById('addextra').textContent = `$${data.addextra.toFixed(2)}`;
    document.getElementById('addbonus').textContent = `$${data.addbonus.toFixed(2)}`;
    document.getElementById('daily').textContent = `$${data.daily}`;
    document.getElementById('weekly').textContent = `$${data.weekly}`;
  }

  function edit() {
    const displayDiv = document.getElementById('extrasDisplay');
    if (displayDiv.style.display === 'none' || !displayDiv.style.display) {
      createEditForm();
    } else {
      displayDiv.style.display = 'none';
    }
  }

  function createEditForm() {
    display = document.getElementById('extrasDisplay');
    const extrasData = safeParse(localStorage.getItem('extrasData')) || {};
    
    display.innerHTML = `
      <button class="close-btn" onclick="edit()">×</button>
      <div><label>Travel allowance:</label><input type="text" id="travelInput" value="${extrasData.travelValue || '0'}"></div>
      <div><label>Food allowance:</label><input type="text" id="foodInput" value="${extrasData.foodValue || '0'}"></div>
      <div><label>Extra allowance:</label><input type="text" id="extraInput" value="${extrasData.extraValue || '0'}"></div>
      <button onclick="sendUpdate()">Update</button>
    `;
    display.style.display = "block";
  }

  function sendUpdate() {
    const extrasObj = {
      travelValue: document.getElementById("travelInput").value || '0',
      foodValue: document.getElementById("foodInput").value || '0',
      extraValue: document.getElementById("extraInput").value || '0'
    };
    localStorage.setItem("extrasData", JSON.stringify(extrasObj));

    document.getElementById('travel').textContent = `$${extrasObj.travelValue}`;
    document.getElementById('food').textContent = `$${extrasObj.foodValue}`;
    document.getElementById('extra').textContent = `$${extrasObj.extraValue}`;

    document.getElementById('extrasDisplay').style.display = "none";
    calculateTotalExpenses();
  }

  function editbtntwo() {
    const displaya = document.getElementById('totalsDisplay');
    if (displaya.style.display === 'none' || !displaya.style.display) {
      displaya.innerHTML = `
        <button class="close-btn" onclick="editbtntwo()">×</button>
        <h3>Edit Totals</h3>
        <div><label>Bill Total:</label><input type="text" id="edit-bill-total" placeholder="Enter amount"></div>
        <div><label>With Extra:</label><input type="text" id="edit-with-extra" placeholder="Enter amount"></div>
        <div><label>With Bonus:</label><input type="text" id="edit-with-bonus" placeholder="Enter amount"></div>
        <button onclick="updateTotals()">Update</button>
      `;
      displaya.style.display = "block";
    } else {
      displaya.style.display = "none";
    }
  }

  function updateTotals() {
    const billTotal = document.getElementById('edit-bill-total').value;
    const withExtra = document.getElementById('edit-with-extra').value;
    const withBonus = document.getElementById('edit-with-bonus').value;

    if (billTotal) document.getElementById('bills').textContent = `$${validateNumber(billTotal).toFixed(2)}`;
    if (withExtra) document.getElementById('addextra').textContent = `$${validateNumber(withExtra).toFixed(2)}`;
    if (withBonus) document.getElementById('addbonus').textContent = `$${validateNumber(withBonus).toFixed(2)}`;

    calculateTotalExpenses();
    document.getElementById('totalsDisplay').style.display = "none";
  }

  function toggleExpenses() {
    const expenseArea = document.getElementById('expenseArea');
    const btn = document.querySelector('.expenses');
    if (expenseArea.style.display === 'none' || !expenseArea.style.display) {
      showExpenses();
      expenseArea.style.display = 'block';
      btn.textContent = 'Hide Expenses';
    } else {
      expenseArea.style.display = 'none';
      btn.textContent = 'Show Expenses';
    }
  }

  function showExpenses() {
    const expenses = safeParse(localStorage.getItem('expenses')) || [];
    const expenseArea = document.getElementById('expenseArea');
    const users = safeParse(localStorage.getItem('users')) || [];
    const username = findUser(users, 0)?.username || 'User';
    
    expenseArea.innerHTML = `
      <div class="expense-header">
        <div class="expense-title">Expenses for ${username}</div>
        <button class="expense-close-btn" onclick="toggleExpenses()">×</button>
      </div>
      <div class="expense-list" id="expenseList"></div>
      <div class="expense-summary" id="expenseSummary"></div>
    `;
    
    const expenseList = document.getElementById('expenseList');
    const expenseSummary = document.getElementById('expenseSummary');
    const userExpenses = expenses.filter(exp => exp.count === 0);
    
    if (userExpenses.length === 0) {
      expenseList.innerHTML = `
        <div class="no-expenses">
          No expenses found. Add some to see them here.
        </div>
      `;
      calculateTotalExpenses();
      return;
    }
    
    let totalAmount = 0;
    let monthlyTotal = 0;
    let yearlyTotal = 0;
    
    userExpenses.forEach(exp => {
      const amt = validateNumber(exp.billamt);
      totalAmount += amt;
      
      // Calculate monthly equivalent
      if (exp.due === 'monthly') {
        monthlyTotal += amt;
        yearlyTotal += amt * 12;
      } else if (exp.due === 'yearly') {
        monthlyTotal += amt / 12;
        yearlyTotal += amt;
      } else if (exp.due === 'weekly') {
        monthlyTotal += amt * 4.33;
        yearlyTotal += amt * 52;
      } else if (exp.due === 'daily') {
        monthlyTotal += amt * 30;
        yearlyTotal += amt * 365;
      }
      
      const item = document.createElement('div');
      item.className = 'expense-item';
      item.innerHTML = `
        <div class="expense-info">
          <div class="expense-name">${exp.billname || 'Unnamed Bill'}</div>
          <div class="expense-frequency">${exp.due ? capitalizeFirstLetter(exp.due) : 'Not specified'}</div>
        </div>
        <div class="expense-amount">$${amt.toFixed(2)}</div>
      `;
      expenseList.appendChild(item);
    });
    
    // Add summary section
    expenseSummary.innerHTML = `
      <div class="expense-total">
        <span class="total-label">Total Amount:</span>
        <span class="total-amount">$${totalAmount.toFixed(2)}</span>
      </div>
      <div class="expense-total">
        <span class="total-label">Monthly Equivalent:</span>
        <span class="total-amount">$${monthlyTotal.toFixed(2)}</span>
      </div>
      <div class="expense-total">
        <span class="total-label">Yearly Equivalent:</span>
        <span class="total-amount">$${yearlyTotal.toFixed(2)}</span>
      </div>
    `;
    
    calculateTotalExpenses();
  }

  function capitalizeFirstLetter(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
  }

function editSalaryGroup() {
    const currentData = JSON.parse(localStorage.getItem('salaryData')) || {
        salary: 0,
        allowance: 0,
        stipend: 0,
        project: 0
    };

    // Create a modal form for better UX
    const modalHtml = `
        <div id="salaryEditModal" style="
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            z-index: 1000;
        ">
            <h3>Edit Salary Group</h3>
            <div style="margin: 10px 0;">
                <label>Salary: </label>
                <input type="number" id="editSalaryValue" value="${currentData.salary}" style="padding: 5px;">
            </div>
            <div style="margin: 10px 0;">
                <label>Stipend: </label>
                <input type="number" id="editStipendValue" value="${currentData.stipend}" style="padding: 5px;">
            </div>
            <div style="margin: 10px 0;">
                <label>Allowance: </label>
                <input type="number" id="editAllowanceValue" value="${currentData.allowance}" style="padding: 5px;">
            </div>
            <div style="margin: 10px 0;">
                <label>Project Cap: </label>
                <input type="number" id="editProjectValue" value="${currentData.project}" style="padding: 5px;">
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button onclick="document.getElementById('salaryEditModal').remove()" style="padding: 5px 10px;">Cancel</button>
                <button onclick="saveSalaryChanges()" style="padding: 5px 10px; background: #4CAF50; color: white; border: none; border-radius: 4px;">Save</button>
            </div>
        </div>
    `;

    // Create and show modal
    const modal = document.createElement('div');
    modal.innerHTML = modalHtml;
    document.body.appendChild(modal);
}

function saveSalaryChanges() {
    // Get values from inputs
    const newData = {
        salary: validateNumber(document.getElementById('editSalaryValue').value),
        stipend: validateNumber(document.getElementById('editStipendValue').value),
        allowance: validateNumber(document.getElementById('editAllowanceValue').value),
        project: validateNumber(document.getElementById('editProjectValue').value)
    };

    // Save to localStorage
    localStorage.setItem('salaryData', JSON.stringify(newData));

    // Update the displayed values
    document.getElementById('salary').textContent = `$${newData.salary}`;
    document.getElementById('stipend').textContent = `$${newData.stipend}`;
    document.getElementById('allowance').textContent = `$${newData.allowance}`;
    document.getElementById('project').textContent = `$${newData.project}`;

    // Remove the modal
    document.getElementById('salaryEditModal').remove();
}

  // Initialization
  // Initialization
document.addEventListener('DOMContentLoaded', function() {
  showLoadingState(true);
  
  try {
    initStorageDefaults();
    
    // Load all data
    const users = safeParse(localStorage.getItem('users')) || [];
    const classes = safeParse(localStorage.getItem('classes')) || [];
    const extrasData = safeParse(localStorage.getItem('extrasData')) || {};
    
    // Load salary data - this is the key change
    const salaryData = safeParse(localStorage.getItem('salaryData')) || {
      salary: 0,
      allowance: 0,
      stipend: 0,
      project: 0
    };
    
    const monthlyExpenses = safeParse(localStorage.getItem('monthlyExpenses')) || {};
    const expenses = safeParse(localStorage.getItem('expenses')) || [];
    
    // Set user and class info
    document.getElementById('name').textContent = `User: ${findUser(users, 0)?.username || 'Not set'}`;
    document.getElementById('class').textContent = `Class: ${findUser(classes, 0)?.classname || 'Not set'}`;
    
    // Load and display salary data - this is where we populate the fields
    document.getElementById('salary').textContent = `$${salaryData.salary}`;
    document.getElementById('allowance').textContent = `$${salaryData.allowance}`;
    document.getElementById('stipend').textContent = `$${salaryData.stipend}`;
    document.getElementById('project').textContent = `$${salaryData.project}`;
    
    // Set up edit salary button
    document.getElementById('editSalaryBtn').addEventListener('click', editSalaryGroup);
    
    // Load and display extras data
    populateExtrasData(extrasData);
    
    // Load and display monthly expenses if they exist
    if (Object.keys(monthlyExpenses).length > 0) {
      document.getElementById('bills').textContent = `$${monthlyExpenses.bills?.toFixed(2) || '0.00'}`;
      document.getElementById('addextra').textContent = `$${monthlyExpenses.addextra?.toFixed(2) || '0.00'}`;
      document.getElementById('addbonus').textContent = `$${monthlyExpenses.addbonus?.toFixed(2) || '0.00'}`;
      document.getElementById('daily').textContent = `$${monthlyExpenses.daily || '0.00'}`;
      document.getElementById('weekly').textContent = `$${monthlyExpenses.weekly || '0.00'}`;
    } else if (expenses.length > 0) {
      // Calculate totals if we have expenses but no monthly data
      calculateTotalExpenses();
    }
    
  } catch (e) {
    console.error('Error loading data:', e);
    handleErrors();
  } finally {
    showLoadingState(false);
  }
});
</script>
</body>
</html>